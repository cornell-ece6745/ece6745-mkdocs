
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Christopher Batten">
      
      
      
        <link rel="prev" href="../ece6745-lab2/">
      
      
        <link rel="next" href="../ece6745-lab4/">
      
      
        
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Lab 3: TinyFlow Front End - ECE 6745 Complex Digital ASIC Design</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ece-6745-lab-3-tinyflow-front-end" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ECE 6745 Complex Digital ASIC Design" class="md-header__button md-logo" aria-label="ECE 6745 Complex Digital ASIC Design" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ECE 6745 Complex Digital ASIC Design
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 3: TinyFlow Front End
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/cornell-ece6745/ece6745-mkdocs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    cornell-ece6745/ece6745-mkdocs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../ece6745-tut00-remote-access/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ece6745-lab1/" class="md-tabs__link">
          
  
  
  Labs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../ece6745-project1a/" class="md-tabs__link">
          
  
  
  Projects

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../ece6745-tinyflow-180nm-drm/" class="md-tabs__link">
          
  
  
  Misc

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ECE 6745 Complex Digital ASIC Design" class="md-nav__button md-logo" aria-label="ECE 6745 Complex Digital ASIC Design" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ECE 6745 Complex Digital ASIC Design
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cornell-ece6745/ece6745-mkdocs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    cornell-ece6745/ece6745-mkdocs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-tut00-remote-access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial 0: ECE Linux Server Remote Access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-tut01-linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial 1: Linux Development Environment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-tut02-git/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial 2: Git Distributed Version Control System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Labs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Labs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 1: Full-Custom Inverter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-lab2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 2: Standard-Cell Inverter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Lab 3: TinyFlow Front End
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 3: TinyFlow Front End
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-logging-into-ecelinux" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Logging Into ecelinux
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-data-structure-forest-of-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Data Structure: Forest of Trees
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Data Structure: Forest of Trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1. Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-front-end-database" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2. Front-End Database
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-printing-trees-and-forests" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2. Printing Trees and Forests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-algorithm-verilog-reader" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Algorithm: Verilog Reader
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-algorithm-unoptimized-technology-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Algorithm: Unoptimized Technology Mapping
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Algorithm: Unoptimized Technology Mapping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-exactly-matching-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Exactly Matching Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-partially-matching-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2. Partially Matching Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-capturing-wildcard-subtrees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3. Capturing Wildcard Subtrees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-replacing-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4. Replacing Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-substitutions" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5. Substitutions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-unoptimized-technology-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.6. Unoptimized Technology Mapping
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-algorithm-gate-level-netlist-writer" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Algorithm: Gate-Level Netlist Writer
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-tinyflow-front-end" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. TinyFlow Front End
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. TinyFlow Front End">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-two-state-rtl-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Two-State RTL Simulation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-four-state-rtl-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Four-State RTL Simulation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-synthesis" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Synthesis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-fast-functional-gate-level-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 Fast-Functional Gate-Level Simulation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-lab4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 4: TinyFlow Back End
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-lab5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 5: TinyRV2 Accelerators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Project 1: TinyFlow Tape-Out
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Project 1: TinyFlow Tape-Out
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-project1a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part A: TinyFlow Standard Cells
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-project1b/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part B: TinyFlow Front End
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-project1c/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Part C: TinyFlow Back End
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Misc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-tinyflow-180nm-drm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tinyflow 180nm Design Rules Manual
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ece6745-project2-ideas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Project 2 Ideas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-logging-into-ecelinux" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Logging Into ecelinux
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-data-structure-forest-of-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Data Structure: Forest of Trees
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Data Structure: Forest of Trees">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1. Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-front-end-database" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2. Front-End Database
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-printing-trees-and-forests" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2. Printing Trees and Forests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-algorithm-verilog-reader" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Algorithm: Verilog Reader
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-algorithm-unoptimized-technology-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Algorithm: Unoptimized Technology Mapping
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Algorithm: Unoptimized Technology Mapping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-exactly-matching-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Exactly Matching Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-partially-matching-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2. Partially Matching Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-capturing-wildcard-subtrees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3. Capturing Wildcard Subtrees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-replacing-trees" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4. Replacing Trees
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-substitutions" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5. Substitutions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-unoptimized-technology-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.6. Unoptimized Technology Mapping
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-algorithm-gate-level-netlist-writer" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Algorithm: Gate-Level Netlist Writer
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-tinyflow-front-end" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. TinyFlow Front End
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. TinyFlow Front End">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-two-state-rtl-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Two-State RTL Simulation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-four-state-rtl-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Four-State RTL Simulation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-synthesis" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Synthesis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-fast-functional-gate-level-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 Fast-Functional Gate-Level Simulation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ece-6745-lab-3-tinyflow-front-end">ECE 6745 Lab 3: TinyFlow Front End</h1>
<p>In this lab, we will explore the TinyFlow front-end which takes as input
a Verilog RTL design and produces a gate-level netlist of standard cells.
The complete TinyFlow standard-cell and ASIC design flow is shown below
with the front end highlighted in red.</p>
<p><img alt="" src="../img/lab3-tinyflow.png" /></p>
<p>The front end includes two-state RTL simulation, four-state RTL
simulation, synthesis, and fast-functional gate-level simulation. In
lecture, we discussed an approach to synthesis based on technology
mapping with dynamic programming to optimize the area of the final
gate-level netlist. In this lab, we will be instead implementing a very
simple unoptimized synthesis tool. The three key algorithms in the
unoptimized synthesis tool are shown below.</p>
<p><img alt="" src="../img/lab3-synth-flow.png" width="50%" /></p>
<p>We will be begin by exploring the key data structure used in the
synthesis tool: a forest of trees where the nodes are generic gates,
standard cells, or signals. We will then explore the verilog reader,
implement an unoptimized technology mapping algorithm, use the provided
gate-level netlist writer to generate the final Verilog gate-level
netlist, and then put these algorithms together into a synthesis tool.
Finally, we will go through the entire end-to-end front end flow for a
full adder.</p>
<h2 id="1-logging-into-ecelinux">1. Logging Into <code>ecelinux</code></h2>
<p>Follow the same process as previous labs. Find a free workstation and log
into the workstation using your NetID and standard NetID password. Then
complete the following steps. These are the same steps as in the previous
lab with one exception. We are now installing the Verilog extension both
on the workstation and on the remote server.</p>
<ul>
<li>Start VS Code</li>
<li>Install the Remote-SSH extension, Surfer, and Verilog extensions</li>
<li>Use View &gt; Command Palette to execute Remote-SSH: Connect Current Window to Host...</li>
<li>Enter netid@ecelinux-XX.ece.cornell.edu where XX is an ecelinux server number</li>
<li>Find the Verilog extension again and install on the remote server</li>
<li>Use View &gt; Explorer to open your home directory on ecelinux</li>
<li>Use View &gt; Terminal to open a terminal on ecelinux</li>
<li>Start MS Remote Desktop</li>
</ul>
<p><img alt="" src="../img/tut00-vscode-verilog.png" /></p>
<p>Now use the following commands to clone the repo we will be using for
today's lab.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>%<span class="w"> </span><span class="nb">source</span><span class="w"> </span>setup-ece6745.sh
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>%<span class="w"> </span><span class="nb">source</span><span class="w"> </span>setup-gui.sh
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>%<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>%<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>git@github.com:cornell-ece6745/ece6745-lab3<span class="w"> </span>lab3
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>lab3
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>%<span class="w"> </span>tree
</span></code></pre></div>
<p>Your repo contains the following files.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>.
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>├── README.md
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>├── asic
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>│   └── build-fa
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>│       ├── 01-verilator-rtlsim
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>│       ├── 02-iverilog-rtlsim
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>│       ├── 03-tinyflow-synth
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>│       │   └── run.py
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>│       └── 04-tinyflow-ffglsim
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>├── rtl
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>│   ├── FullAdder.v
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>│   └── test
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>│       └── FullAdder-test.v
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>├── stdcells
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>└── tinyflow
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    ├── synth
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    │   ├── StdCellFrontEndView.py
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    │   ├── TinyFrontEndDB.py
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    │   ├── TinyFrontEndGUI.py
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    │   ├── print.py
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    │   ├── substitute.py
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    │   ├── techmap_unopt.py
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    │   ├── tinyv.lark
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    │   └── verilog_parser.py
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    └── tinyflow-synth
</span></code></pre></div>
<p>Our front-end flow use the behavioral and front-end views you developed
in Project 1, Part A. Copy these views into the lab3 directory.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/stdcells
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>%<span class="w"> </span>cp<span class="w"> </span>project1-groupXX/stdcells/stdcells.v<span class="w"> </span>.
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>%<span class="w"> </span>cp<span class="w"> </span>project1-groupXX/stdcells/stdcells-fe.yml<span class="w"> </span>.
</span></code></pre></div>
<p>where <code>XX</code> is your group number.</p>
<p>To make it easier to cut-and-paste commands from this handout onto the
command line, you can tell Bash to ignore the <code>%</code> character using the
following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>%<span class="w"> </span><span class="nb">alias</span><span class="w"> </span>%<span class="o">=</span><span class="s2">&quot;&quot;</span>
</span></code></pre></div>
<p>Now you can cut-and-paste a sequence of commands from this tutorial
document and Bash will not get confused by the <code>%</code> character which begins
each line.</p>
<h2 id="2-data-structure-forest-of-trees">2. Data Structure: Forest of Trees</h2>
<p>As discussed in lecture, the synthesis data structure used in our basic
front-end is a forest of trees where nodes can be generic gates, standard
cells, or signals. The synthesis algorithms create, transform, and
analyze this forest of trees. The forest of trees is stored in a
front-end database which includes methods for reading files into the
databse and writing files from the database. We provide students the
database, and students are responsible for writing the algorithms.</p>
<p>To get started, create a build directory and start the TinyFlow synthesis
REPL.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>%<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>%<span class="w"> </span>../tinyflow-synth
</span></code></pre></div>
<p>You should see the following:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>TinyFlow Synth REPL v0.1
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Type &#39;help()&#39; for available commands.
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>Type &#39;clear()&#39; to clear the screen.
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>Type &#39;exit()&#39; or Ctrl-D to quit.
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>tinyflow-synth&gt;
</span></code></pre></div>
<p><code>tinyflow-synth&gt;</code> is the TinyFlow synthesis REPL prompt which will enable
you to intereactively experiment with different synthesis data structures
and algorithms. The TinyFlow synthesis REPL is basically the Python REPL
with a few extra features so most standard Python command should work as
well. You can use <code>help()</code> to see the available commands.</p>
<h3 id="21-trees">2.1. Trees</h3>
<p>The nodes in a tree can either be generic gates, standard cells, or
signals. The base class for all nodes is <code>Node</code>.</p>
<ul>
<li>
<p>Generic-gate nodes represent generic logic operations. There is no area
   nor delay associated with a generic logic operation. Generic-gate
   nodes are named without an X1 suffix (e.g., BUF, NOT, INV, AND2, OR2,
   XOR, NAND2, NOR2, XNOR2).</p>
</li>
<li>
<p>Standard-cell nodes represent standard cells from our library. The
   front-end view provides the list of valid standard-cell nodes and the
   associated area and delay. Standard-cell nodes are named with an X1
   suffix (e.g., INVX1, NAND2X1, NOR2X1, AOI21X1).</p>
</li>
<li>
<p>Signal nodes represent input ports and wires. Every leaf of all every
   tree must be a signal node.</p>
</li>
</ul>
<p>There are also special <code>Wildcard</code> nodes that we will explain later. Let's
start by creating three signals and a simple tree with a total of five
nodes: two generic-gate nodes and three signal nodes.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">tree1</span> <span class="o">=</span> <span class="n">AND2</span><span class="p">(</span> <span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span> <span class="p">)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tree1</span><span class="p">)</span>
</span></code></pre></div>
<p>Note that the TinyFlow REPL will automatically ignore the leading
<code>tinyflow-synth&gt;</code> so you should be able to copy-and-paste the above
commands directly into the REPL.</p>
<p>Every node has a <code>type</code> field and a list of its children. Let's print the
type of every node in the tree.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tree1</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</span></code></pre></div>
<p>Each node also has the following helper methods</p>
<ul>
<li><code>is_generic_gate()</code></li>
<li><code>is_standard_cell()</code></li>
<li><code>is_signal()</code></li>
<li><code>is_wildcard()</code></li>
</ul>
<p>Go ahead and check to see which of the five nodes are generic-gate nodes.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">tree1</span><span class="o">.</span><span class="n">is_generic_gate</span><span class="p">()</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_generic_gate</span><span class="p">()</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_generic_gate</span><span class="p">()</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_generic_gate</span><span class="p">()</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">tree1</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_generic_gate</span><span class="p">()</span>
</span></code></pre></div>
<p>The <code>==</code>/<code>!=</code> operators compare nodes by type. You can also evaluate a
tree using the <code>eval</code> method. So the following will evaluate our tree
when the input ports are set to the given values.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>tinyflow-synth&gt; print(tree1.eval(a=0, b=0, c=0))
</span></code></pre></div>
<p>Go ahead and evaluate all input combinations using <code>tree.eval()</code> and
derive the truth table for <code>AND2(OR2(a, b), c)</code>. Does it match your
expectations?</p>
<p>Use the TinyFlow REPL to create the following tree.</p>
<p><img alt="" src="../img/lab3-tree1.png" width="25%" /></p>
<p>Evaluate all possible inputs to confirm that it implements the following
truth table.</p>
<table>
<thead>
<tr>
<th>a</th>
<th>b</th>
<th>c</th>
<th>y</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>
<h3 id="22-front-end-database">2.2. Front-End Database</h3>
<p>The front-end database stores a forest of trees. To create a database
using <code>TinyFrontEndDB</code>, we first need to have our front-end view ready.
<code>StdCellFrontEndView</code> loads the front-end view YAML file. It provides
access to cell information (area, timing parameters), patterns for
technology mapping, and standard cell gate classes (INVX1, NAND2X1,
etc.).</p>
<p>Let's create the view and database:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span></code></pre></div>
<p>The database supports visualizing its contents through a GUI. Enable the
GUI with:</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">enable_gui</span><span class="p">()</span>
</span></code></pre></div>
The GUI window will open.</p>
<p><img alt="" src="../img/lab3-gui-blank.png" /></p>
<p>Now add inputs, outputs, and set a tree:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_inports</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_outports</span><span class="p">([</span><span class="s2">&quot;out&quot;</span><span class="p">])</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">get_tree</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Watch the GUI update to show your tree when you call <code>db.set_tree(...)</code>.</p>
<p><img alt="" src="../img/lab3-gui-simple.png" /></p>
<p>In the visualization above, you will only see primary inputs, primary
outputs, and generic gates. The GUI uses the following visual
conventions:</p>
<ul>
<li><strong>Green ovals:</strong> Primary inputs</li>
<li><strong>Orange ovals:</strong> Wire signals</li>
<li><strong>Blue ovals:</strong> Primary outputs</li>
<li><strong>Grey rectangles:</strong> Generic gates</li>
<li><strong>Red rectangles:</strong> Standard cell gates</li>
</ul>
<p><img alt="" src="../img/lab3-gui-types.png" /></p>
<p>Add the following tree to the front-end database and verify you can see
both the old and new tree in the GUI.</p>
<p><img alt="" src="../img/lab3-tree1.png" width="25%" /></p>
<p>Once you are done with the GUI, you can exit the REPL by calling <code>exit()</code>
or pressing Ctrl-D.</p>
<h3 id="22-printing-trees-and-forests">2.2. Printing Trees and Forests</h3>
<p>Let's write some functions to print trees and forests. Open the
<code>print.py</code> file in VS Code.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>%<span class="w"> </span>code<span class="w"> </span>../synth/print.py
</span></code></pre></div>
<p>Find the <code>print_tree</code> and <code>print_tree_h</code> functions.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_tree_h</span><span class="p">(</span> <span class="n">node</span><span class="p">,</span> <span class="n">indent</span> <span class="p">):</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  <span class="o">...</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_tree</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span> <span class="n">name</span> <span class="p">):</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>The <code>print_tree</code> function takes as input the front-end database and the
name of the tree to print (i.e., the name of the output port at the root
of the tree) and should print each node in the tree using indentation to
indicate the depth of the node. So printing the <code>AND2(OR2(a, b), c))</code>
tree should output</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>AND2
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>  OR2
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    a
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    b
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>  c
</span></code></pre></div>
<p>The <code>print_tree</code> function should get the correct tree from the database
and then call the recursive <code>print_tree_h</code> helper function. The recursive
helper function should use a preorder tree traversal to print the tree:</p>
<ul>
<li><em>Step 1:</em> Print leading spaces based on <code>indent</code></li>
<li><em>Step 2:</em> Print the type for a generic-gate node or the name for a signal node</li>
<li><em>Step 3:</em> Recusively call helper function for all children with <code>indent+1</code></li>
</ul>
<p>Once you have finished writing your <code>print_tree</code> function try it out
using the TinyFlow REPL.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_inports</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_outports</span><span class="p">([</span><span class="s2">&quot;out&quot;</span><span class="p">])</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">print_tree</span><span class="p">(</span> <span class="n">db</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span> <span class="p">)</span>
</span></code></pre></div>
<p>Now find the <code>print_forest</code> function.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_forest</span><span class="p">(</span> <span class="n">db</span> <span class="p">):</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>This function should iterate across all trees in the forest and print
each one using <code>print_tree</code>. Trees are stored as a dictionary in the
database. The dictionary maps the name of the tree (i.e, the name of the
output port or wire) to the actual tree. So you can iterate over the
trees in a front-end database like this.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>  <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">tree</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="o">...</span> <span class="n">do</span> <span class="n">something</span> <span class="k">with</span> <span class="n">the</span> <span class="n">name</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">tree</span> <span class="o">...</span>
</span></code></pre></div>
<p>Once you have finished writing your <code>print_forest</code> function try it out
using the TinyFlow REPL.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_inports</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_outports</span><span class="p">([</span><span class="s2">&quot;out1&quot;</span><span class="p">])</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="s2">&quot;out1&quot;</span><span class="p">,</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_inports</span><span class="p">([</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">])</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_outports</span><span class="p">([</span><span class="s2">&quot;out2&quot;</span><span class="p">])</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="s2">&quot;out2&quot;</span><span class="p">,</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)))</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">print_forest</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="3-algorithm-verilog-reader">3. Algorithm: Verilog Reader</h2>
<p>The first step of our synthesis flow is reading the Verilog RTL design
to create the forest of trees data structure. This has three steps:
lexing, parsing, and foresting.</p>
<p>In this part, we will be discussing the limitations of verilog we can
write for the TinyFlow. This limitation is mainly pedagogical to simplify
the flow as well as limitations due to our parser. First let's look at
the full adder we will be using as the motivation example in his lab.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>%<span class="w"> </span>code<span class="w"> </span>../../rtl/FullAdder.v
</span></code></pre></div>
<p>The full adder adheres to the following rules.</p>
<ol>
<li>Only combinational Verilog</li>
<li>Only single-bit signals of type <code>wire</code></li>
<li>Only single-bit bitwise operators (<code>&amp;</code>, <code>|</code>, <code>^</code>, <code>~</code>)</li>
<li>No hierarchy</li>
</ol>
<p>Take a look at the Lark grammar which captures these rules.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>%<span class="w"> </span>code<span class="w"> </span>../synth/tinyv-lab3.lark
</span></code></pre></div>
<p>The grammer is shown below.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>start: module
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>//------------------------------------------------------------------------
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>// Module
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>//------------------------------------------------------------------------
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>module: &quot;module&quot; MNAME port_decl_list? &quot;;&quot; stmt* &quot;endmodule&quot;
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>port_decl_list: &quot;(&quot; port_decl (&quot;,&quot; port_decl)* &quot;)&quot;
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>port_decl: DIR (&quot;wire&quot; | &quot;logic&quot;)? SIGNAL
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>DIR: &quot;input&quot; | &quot;output&quot;
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>stmt: decl_wire | assignment
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>//------------------------------------------------------------------------
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>// Statements
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>//------------------------------------------------------------------------
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>decl_wire:  &quot;wire&quot; SIGNAL (&quot;,&quot; SIGNAL)* &quot;;&quot;
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>assignment: &quot;assign&quot; SIGNAL &quot;=&quot; expr &quot;;&quot;
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>//------------------------------------------------------------------------
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>// Expressions
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>//------------------------------------------------------------------------
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>?expr:
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>  | expr &quot;|&quot; expr -&gt; or
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>  | expr &quot;^&quot; expr -&gt; xor
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>  | expr &quot;&amp;&quot; expr -&gt; and
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>  | expr &quot;+&quot; expr -&gt; sum
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>  | &quot;~&quot; expr      -&gt; not
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>  | &quot;(&quot; expr &quot;)&quot;
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>  | SIGNAL
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>//------------------------------------------------------------------------
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>// Terminals
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>//------------------------------------------------------------------------
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>SIGNAL:  /[a-zA-Z_][a-zA-Z0-9_]*/
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>MNAME:   /[a-zA-Z_][a-zA-Z0-9_]*/
</span></code></pre></div>
<p>The front-end database includes a <code>parse_verilog</code> method which will
perform lexing and parsing for a Verilog RTL design before displaying the
AST.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">parse_verilog</span><span class="p">(</span><span class="s2">&quot;../../rtl/FullAdder.v&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Try to see how the AST corresponds to the Verilog RTL design. Now let's
use the <code>read_verilog</code> method to do all three steps: lexing, parsing, and
foresting. Watch the GUI update to show the parsed trees.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">enable_gui</span><span class="p">()</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">read_verilog</span><span class="p">(</span><span class="s2">&quot;../../rtl/FullAdder.v&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="4-algorithm-unoptimized-technology-mapping">4. Algorithm: Unoptimized Technology Mapping</h2>
<p>Our unoptimized technology mapping algorithm will be very simple. It will
replace every generic gate with a logically equivalent subtree of
standard cells. We will not be trying to optimize area. We are simply
trying to develop the most basic possible technology mapping algorithm.</p>
<p>We will develop a subtree substitution framework which we can then use to
implement the unoptimized technology mapping algorithm. You can also use
this subtree substitution framework to implement canoncalization and
optimized technology mapping in the project. The subtree substitution
framework will enable us to create a substitute like this:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">Substitute</span><span class="p">(</span> <span class="n">find</span><span class="o">=</span><span class="n">AND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="n">INV</span><span class="p">(</span><span class="n">NAND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">)</span> <span class="p">))</span>
</span></code></pre></div>
<p>Once we have created a substitute we can <em>apply</em> to a tree. So applying
the above subsittute would find every AND2 generig cate and replace it
with a new INV/NAND2 subtree. Substitutes make use of wildcard nodes
which are denoted using <code>_0</code>, <code>_1</code>, <code>_2</code>, and <code>_3</code>. A wildcard node will
matches any subtree.</p>
<p>So let's say we start with the tree on the left and we want to apply the
above substitute to create the tree on the right.</p>
<p><img alt="" src="../img/lab3-tree2.png" width="60%" /></p>
<p>Our goal is to be able to do this as follows.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">Substitute</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">AND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="n">INV</span><span class="p">(</span><span class="n">NAND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">)))</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></code></pre></div>
<p>This is pretty complicated to implement, so we will take an incremental
approach. We will start by implementing an exact match algorithm before
implementing a partial match algorithm. Then we will work on capturing
the wildcard subtrees from a partial match. We will implement the actual
replacement before finalyl creating a substitution. Then we can use this
to implement the unoptimized technology mapping.</p>
<h3 id="41-exactly-matching-trees">4.1. Exactly Matching Trees</h3>
<p>Our first step is to implement an exact match algorithm. Our earlier work
on printing trees only traversed a single tree. Here we will need to
recurse two trees in parallel to see if they match exactly.</p>
<p>Open the <code>substitute.py</code> file in VS Code.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>%<span class="w"> </span>code<span class="w"> </span>../synth/substitute.py
</span></code></pre></div>
<p>Find the <code>match_exact</code> function in <code>substitute.py</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">match_exact</span><span class="p">(</span> <span class="n">node</span><span class="p">,</span> <span class="n">p_node</span> <span class="p">):</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>This recursive function takes as input two nodes in two trees and
compares the corresponding subtrees starting from these two nodes using
the following steps.</p>
<ul>
<li>
<p><em>Base Case:</em> If the nodes are not equal return false</p>
</li>
<li>
<p><em>Recursive Case:</em> Recursively call function for all children, keep track
   if any children return false and if so then this function should
   return false, otherwise return true</p>
</li>
</ul>
<p>You can use the Python <code>zip</code> function to easily iterate over the children
of both nodes together like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>  for p_child, n_child in zip( p_node.children, node.children ):
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>    ... do something with p_child and n_child ...
</span></code></pre></div>
<p>Once you have implemented your exact match algorithm, try it out using
the TinyFlow REPL.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match_exact</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span> <span class="p">)</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match_exact</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span> <span class="p">)</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match_exact</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">)</span>
</span></code></pre></div>
<h3 id="42-partially-matching-trees">4.2. Partially Matching Trees</h3>
<p>Now that we know how to recursively traverse two trees in parallel, let's
implement a partial match algorithm. Here is where we will start to take
advantage of wildcards. A wildcard matches any subtree. The REPL provides
predefined wildcards <code>_0</code>, <code>_1</code>, <code>_2</code>, <code>_3</code> for convenience. For example,
if we have the tree below on the left, we want to be able to determine
that the pattern on the right matches since there is an AND2 gate at the
root of the tree on the left.</p>
<p><img alt="" src="../img/lab3-tree3.png" width="50%" /></p>
<p><img alt="" src="../img/lab3-tree4.png" width="50%" /></p>
<p><img alt="" src="../img/lab3-tree5.png" width="50%" /></p>
<p>Find the <code>match</code> function in <code>substitute.py</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span> <span class="n">node</span><span class="p">,</span> <span class="n">p_node</span> <span class="p">):</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>This recursive function takes as input two nodes in two trees. The
<code>p_node</code> tree is the <em>pattern</em> tree (i.e., the tree with wildcards) while
the <code>node</code> tree is the tree want want to search over. The function
compares the corresponding subtrees starting from these two nodes using
the following steps.</p>
<ul>
<li>
<p><em>Base Case 1</em>: If the current <code>p_node</code> is a wildcard (i.e.,
   <code>is_wildcard()</code> returns true) then it always matches the corresponding
   <code>node</code> so return true.</p>
</li>
<li>
<p><em>Base Case 2</em>: If the current <code>p_node</code> does not equal the current
   <code>node</code> (i.e., use <code>!=</code> which compares the types of the two nodes) then
   there is no match so return false.</p>
</li>
<li>
<p><em>Recursive Case</em>: Recursively call function for all children, keep
   track if any children return false and if so then this function should
   return false, otherwise return true</p>
</li>
</ul>
<p>Test your implementation in the REPL:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span><span class="n">_1</span><span class="p">),</span> <span class="n">_2</span><span class="p">)</span> <span class="p">)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span><span class="n">_1</span><span class="p">),</span> <span class="n">_2</span><span class="p">)</span> <span class="p">)</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">AND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span><span class="n">_1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match</span><span class="p">(</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)),</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span><span class="n">_1</span><span class="p">))</span> <span class="p">)</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">match</span><span class="p">(</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)),</span> <span class="n">INV</span><span class="p">(</span><span class="n">_0</span><span class="p">)</span> <span class="p">)</span>
</span></code></pre></div>
<p>Notice how the final three matches should return true since the pattern
partially matches the given tree.</p>
<h3 id="43-capturing-wildcard-subtrees">4.3. Capturing Wildcard Subtrees</h3>
<p>Now that we can recursively compare two trees, we want to also <em>capture</em>
whatever the wildcards in the pattern tree match to. So in the following
example, wildcard <code>_0</code> captures the <code>OR(a,b)</code> subtree and wildcard <code>_1</code>
captures the <code>c</code> signal node.</p>
<p><img alt="" src="../img/lab3-tree3.png" width="50%" /></p>
<p>The captures should be a dictionary mapping the wildcard name to the
subtree it matched. For example, matching <code>AND2(OR2(a, b), c)</code> against
pattern <code>AND2(_0, _1)</code> produces <code>{"_0": OR2(a, b), "_1": c}</code>.</p>
<p>Find the <code>capture</code> function in <code>substitute.py</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">capture</span><span class="p">(</span> <span class="n">node</span><span class="p">,</span> <span class="n">p_node</span> <span class="p">):</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>This recursive function takes as input two nodes in two trees. The
<code>p_node</code> tree is the <em>pattern</em> tree (i.e., the tree with wildcards) while
the <code>node</code> tree is the tree want want to search over. The <code>capture</code>
algorithm can assume we have already used the <code>match</code> algorithm to
confirm there is indeed a partial match. The function compares the
corresponding subtrees starting from these two nodes using the following
steps.</p>
<ul>
<li>
<p>Base Case: If the current <code>p_node</code> is a wildcard (i.e.,
   <code>is_wildcard()</code> returns true) then we want to capture the
   corresponding subtree starting at <code>node</code>. Return a new dictionary that
   maps the wild card name (i.e., <code>p_node.name</code>) to <code>node</code>.</p>
</li>
<li>
<p>Recursive Case: Recursively call function for all children, keep a
   running dictionary and merge in the dictionary returned from each
   recursive function call. You can use the <code>|=</code> operator to merge a new
   dictionary into an existing dictionary.</p>
</li>
</ul>
<p>Test your implementation in the REPL:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">capture</span><span class="p">(</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">),</span> <span class="n">AND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span><span class="n">_1</span><span class="p">)</span> <span class="p">)</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">capture</span><span class="p">(</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)),</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span><span class="n">_1</span><span class="p">))</span> <span class="p">)</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">capture</span><span class="p">(</span> <span class="n">INV</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)),</span> <span class="n">INV</span><span class="p">(</span><span class="n">_0</span><span class="p">)</span> <span class="p">)</span>
</span></code></pre></div>
<h3 id="44-replacing-trees">4.4. Replacing Trees</h3>
<p>Now that we can match and capture subtrees, we want to build a new tree
using the captured subtrees. Find the <code>replace</code> function in
<code>substitute.py</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span> <span class="n">t_node</span><span class="p">,</span> <span class="n">captures</span> <span class="p">):</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>This recursive function takes as input a node in the <em>template</em> tree and
the captures. The tempalte tree is the tree that we want to insert the
captured subtrees. The function should use the following steps.</p>
<ul>
<li>
<p>Base Case: If the current <code>t_node</code> is a wildcard (i.e.,
   <code>is_wildcard()</code> returns true) then we want to insert the corresponding
   captured subtree at this point. So all we need to do is look up the
   wildcard in the captures dictionary (i.e., <code>captures[t_node.name]</code>)
   and return the result.</p>
</li>
<li>
<p>Recursive Case: Recursively call function for all children and append
   the subtree returned from each recursive function call to running list
   of new children. Once you have finished iterating over all of the
   children create a copy of the current <code>t_node</code> using the list of
   children (e.g., <code>type(t_node)(*children)</code>). Return this new node.</p>
</li>
</ul>
<p>Test your implementation in the REPL:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">AND2</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">)</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">INV</span><span class="p">(</span><span class="n">NAND2</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">))</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">captures</span> <span class="o">=</span> <span class="n">capture</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">captures</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="45-substitutions">4.5. Substitutions</h3>
<p>Now that we have implemented <code>match</code> (to check if a tree matches a
pattern), <code>capture</code> (to extract the subtrees that wildcards match), and
<code>replace</code> (to build a new tree using captured subtrees), we have the core
implementation for the substitution framework.</p>
<p>The <code>Substitute</code> class is a container that holds a find pattern and a
replace template. Find the <code>Substitute</code> class in <code>substitute.py</code>. Go
ahead and implement the <code>apply</code> method which combines <code>match</code>, <code>capture</code>,
and <code>replace</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>The basic approach is:</p>
<ul>
<li>use the match function to see if there is match between the given node
   and the stored find pattern</li>
<li>if there is a match, then use the capture function to capture the
   wildcard subtrees, and the replace these captures</li>
</ul>
<p>Test your implementation in the REPL:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">Substitute</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">AND2</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="n">INV</span><span class="p">(</span><span class="n">NAND2</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">)))</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">AND2</span><span class="p">(</span><span class="n">OR2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="46-unoptimized-technology-mapping">4.6. Unoptimized Technology Mapping</h3>
<p>Now we can use our substitution framework to implement unoptimized
technology mapping where we replace each generic gate with a
corresponding standard cell. For example, to map AND2 to NAND2X1 + INVX1:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">Substitute</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">AND2</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">INVX1</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">NAND2X1</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">)))</span>
</span></code></pre></div>
<p>Note that you can access standard cell classes directly from the view
using <code>view.INVX1</code>, <code>view.NAND2X1</code>, etc.</p>
<p>Implement <code>techmap_unopt</code> in <code>synth/techmap_unopt.py</code>. The function takes
the database and view as arguments:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">techmap_unopt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>  <span class="o">...</span>
</span></code></pre></div>
<p>First, we will need to define substitution rules for each generic gate
type. Just focus on the gates we need for the full adder: AND2, OR2, NOT.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">rules</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>  <span class="n">Substitute</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">AND2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">INVX1</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">NAND2X1</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">))),</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>  <span class="n">Substitute</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">OR2</span><span class="p">(</span><span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span>  <span class="n">replace</span><span class="o">=...</span><span class="p">),</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>  <span class="n">Substitute</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="n">NOT</span><span class="p">(</span><span class="n">_0</span><span class="p">),</span>      <span class="n">replace</span><span class="o">=...</span><span class="p">),</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="p">]</span>
</span></code></pre></div>
<p>Next, implement an <code>apply_rules</code> helper function that recursively applies
rules bottom-up. The key insight is that we must transform children first
before transforming the current node. This ensures that when we match a
pattern at a node, its children have already been mapped to standard
cells. The function should: (1) return immediately for Signal nodes (base
case), (2) recursively apply rules to all children first, (3) iterate
through all rules and try each one on the current node -- return the
result as soon as a rule matches (first match wins), (4) return the node
unchanged if no rules match.</p>
<p>Finally, iterate through all trees in the database and apply the rules:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>  <span class="n">tree</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_tree</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>  <span class="n">new_tree</span> <span class="o">=</span> <span class="n">apply_rules</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>  <span class="n">db</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">)</span>
</span></code></pre></div>
<p>Test your implementation with the REPL and GUI. After running techmap,
the grey generic gates should become red standard cell gates:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">enable_gui</span><span class="p">()</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">read_verilog</span><span class="p">(</span><span class="s2">&quot;../../rtl/FullAdder.v&quot;</span><span class="p">)</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">techmap_unopt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="5-algorithm-gate-level-netlist-writer">5. Algorithm: Gate-Level Netlist Writer</h2>
<p>We provide you a gate-level netlist writer which will write a forest of
trees of standard-cell nodes to a Verilog file. You can try it out like
this.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">),</span> <span class="n">Signal</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_inports</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">add_outports</span><span class="p">([</span><span class="s2">&quot;out1&quot;</span><span class="p">])</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">set_tree</span><span class="p">(</span><span class="s2">&quot;out1&quot;</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">NAND2X1</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">NOR2X1</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span><span class="p">))</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">write_verilog</span><span class="p">(</span><span class="s2">&quot;test.v&quot;</span><span class="p">)</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="n">tinyflow</span><span class="o">-</span><span class="n">synth</span><span class="o">&gt;</span> <span class="n">exit</span><span class="p">()</span>
</span></code></pre></div>
<p>Now take a look at the generated Verilog gate-level netlist.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/ece6745/lab3/tinyflow/build
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>%<span class="w"> </span>cat<span class="w"> </span>test.v
</span></code></pre></div>
<h2 id="6-tinyflow-front-end">6. TinyFlow Front End</h2>
<p>As discussed in lecture, the front end is more than just synthesis. The
front-end flow consists of four stages: two-state simulation, four-state
simulation, synthesis, and fast-functional gate-level simulation. As
paranoid ASIC engineers, we verify our design at each step. We simulate
the RTL before synthesis to catch design bugs early, then simulate the
gate-level netlist after synthesis to ensure the transformation preserved
functionality.</p>
<h3 id="41-two-state-rtl-simulation">4.1 Two-State RTL Simulation</h3>
<p>To ensure functionality, the first step is to verify our design quickly
using two-state simulation. Two-state simulation tests only logic values
1 and 0 to ensure basic logic correctness. In this part we will use
Verilator to perform two-state simulation.</p>
<p>In this lab we will verify a Full Adder design. We provide the Verilog
RTL in <code>rtl/FullAdder.v</code> and a basic testbench in
<code>rtl/test/FullAdder-test.v</code>. Take a look at both files to understand the
design and test structure.</p>
<p>Now run the two-state simulation with Verilator:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>/ece6745/lab3/asic/build-fa/01-verilator-rtlsim
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>%<span class="w"> </span>verilator<span class="w"> </span>--top<span class="w"> </span>Top<span class="w"> </span>--timing<span class="w"> </span>--binary<span class="w"> </span>-o<span class="w"> </span>FullAdder-test<span class="w"> </span><span class="se">\</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span>../../../rtl/FullAdder.v<span class="w"> </span><span class="se">\</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span>../../../rtl/test/FullAdder-test.v
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>%<span class="w"> </span>./obj_dir/FullAdder-test
</span></code></pre></div>
<p>As discussed in lecture, two-state simulation has a limitation:
unassigned signals default to 0. This can hide bugs in your design. For
example, if you forget to assign an output, two-state simulation will
silently use 0 instead of flagging an error.</p>
<p>Try this experiment: comment out the <code>assign g = a &amp; b;</code> line in your
Full Adder and re-run the simulation. Notice that <code>g</code> silently takes the
value 0 instead of producing an error. This is why we need four-state
simulation in the next step. Change the code back before continuing.</p>
<h3 id="42-four-state-rtl-simulation">4.2 Four-State RTL Simulation</h3>
<p>Four-state simulation uses four logic values: 0, 1, X (unknown), and Z
(high impedance). You get X when a signal is uninitialized, when multiple
drivers are fighting (contention), or through propagation of uncertainty
(X propagates through logic). You get Z when a wire is floating (nothing
is driving it) or from a tri-stated output.</p>
<p>We use four-state simulation to capture these bugs. It is slower than
two-state simulation, but it narrows down our issue search space. If your
design passes two-state but fails four-state, the problem is usually
related to X propagation or uninitialized signals.</p>
<p>Go ahead and run the four-state simulation with Icarus Verilog:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>/ece6745/lab3/asic/build-fa/02-iverilog-rtlsim
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>%<span class="w"> </span>iverilog<span class="w"> </span>-g2012<span class="w"> </span>-o<span class="w"> </span>FullAdder-test<span class="w"> </span><span class="se">\</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span>../../../rtl/FullAdder.v<span class="w"> </span><span class="se">\</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span>../../../rtl/test/FullAdder-test.v
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>%<span class="w"> </span>./FullAdder-test
</span></code></pre></div>
<p>Now try the same experiment: comment out the <code>assign g = a &amp; b;</code> line and
re-run the simulation. This time you should see the simulation catch the
error because <code>g</code> becomes X instead of silently defaulting to 0. Change
the code back before continuing.</p>
<h3 id="43-synthesis">4.3 Synthesis</h3>
<p>Now that we have rigorously tested our Verilog design, we are ready to
synthesize it into a gate-level netlist. For this step, we will use the
batch processing mode of <code>tinyflow-synth</code> instead of the REPL mode we
have previous used. The batch mode takes a run script that describes the
synthesis steps.</p>
<p>Go ahead and edit the run script:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>/ece6745/lab3/asic/build-fa/03-tinyflow-synth
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>%<span class="w"> </span>code<span class="w"> </span>run.py
</span></code></pre></div>
<p>Populate the script with the commands to perform technology mapping:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">view</span> <span class="o">=</span> <span class="n">StdCellFrontEndView</span><span class="o">.</span><span class="n">parse_lib</span><span class="p">(</span><span class="s2">&quot;../../../stdcells/stdcells-fe.yml&quot;</span><span class="p">)</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">db</span> <span class="o">=</span> <span class="n">TinyFrontEndDB</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">db</span><span class="o">.</span><span class="n">read_verilog</span><span class="p">(</span><span class="s2">&quot;../../../rtl/FullAdder.v&quot;</span><span class="p">)</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="n">techmap_unopt</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="n">db</span><span class="o">.</span><span class="n">write_verilog</span><span class="p">(</span><span class="s2">&quot;post-synth.v&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Now run the synthesis:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>/ece6745/lab3/asic/build-fa/03-tinyflow-synth
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>%<span class="w"> </span>../../../tinyflow/tinyflow-synth<span class="w"> </span>-f<span class="w"> </span>run.py
</span></code></pre></div>
<p>This outputs the <code>post-synth.v</code> file. Open it and have a look. You should
see that all gates are now standard cells from your library, and the
module still has the same inputs and outputs as the original RTL.</p>
<h3 id="44-fast-functional-gate-level-simulation">4.4 Fast-Functional Gate-Level Simulation</h3>
<p>Now that we have our synthesized design, as paranoid ASIC engineers we
want to double check that the synthesized design still does what we
intended. Synthesis tools may not always be correct! To verify this, we
perform fast-functional gate-level simulation (FFGL), which is four-state
simulation using the same testbench but with the synthesized design and
the behavioral view of the standard cells.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>%<span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$HOME</span>/ece6745/lab3/asic/build-fa/04-iverilog-ffglsim
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>%<span class="w"> </span>iverilog<span class="w"> </span>-g2012<span class="w"> </span>-o<span class="w"> </span>FullAdder-test<span class="w"> </span><span class="se">\</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">    </span>../../../stdcells/stdcells.v<span class="w"> </span>../03-tinyflow-synth/post-synth.v<span class="w"> </span><span class="se">\</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span>../../../rtl/test/FullAdder-test.v
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>%<span class="w"> </span>./FullAdder-test
</span></code></pre></div>
<p>If the simulation passes, your synthesized design is functionally
correct.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Christopher Batten
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../js/extras.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
      
        <script src="../js/wavedrom_loader.js"></script>
      
    
  </body>
</html>